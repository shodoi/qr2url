<!DOCTYPE html>
<html lang="ja">
	<head>
		<meta charset="UTF-8">
		<title>QRコードを選択でURLが分かるようにする</title>
		<style>
			#wrapper {
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				width: 100%;
				height: 100%;
			}

			#canvas {
				display: block;
			}

			#canvas2 {}

			#url {
				position: relative;
				z-index: 10;
			}
		</style>
	</head>
	<body>
		<img src="google.png" alt=""><br>
		<img src="QR_code_desktop_Japanese_Wikipedia.svg" alt="" style="margin: 10px;">

		<div id="wrapper">
			<canvas id="canvas" width="" height="" onmousedown="OnMousedown(event);" onmousemove="OnMousemove(event);" onmouseup="OnMouseup(event);"></canvas>
			<canvas id="canvas2"></canvas>
		</div>
		<div id="url">
		</div>
		<script src="node_modules/html2canvas/dist/html2canvas.min.js"></script>
		<script src="node_modules/jsqr/dist/jsQR.js"></script>
		<script>
			const canvasWrap = document.querySelector('#wrapper');
			const canvasElement = document.querySelector('#canvas');
			const canvasElement2 = document.querySelector('#canvas2');
			const urlEmement = document.querySelector("#url");

			// canvasサイズ設定
			const setCanvasSize = () => {
				const width = canvasWrap.offsetWidth;
				const height = canvasWrap.offsetHeight;
				canvasElement.setAttribute("width", width);
				canvasElement.setAttribute("height", height);
				html2canvas(document.body).then(canvas => {
					const ctx = canvas.getContext('2d');
					const image_data = ctx.getImageData(0, 0, canvas.width, canvas.height);
					image = canvas;
				});
			}

			// QRコードを受け取りURLを返す
			const checkqrcode = (canvas) => {
				const ctx = canvas.getContext('2d');
				const image_data = ctx.getImageData(0, 0, canvas.width, canvas.height);
				const code = jsQR(image_data.data, canvas.width, canvas.height);
				if (code) {
					urlEmement.append('QRコードのURL：' + code.data);
				} else {
					urlEmement.append('QRコードが正しくありません');
				}
			}

			let resizeTimer;

			// ブラウザリサイズ時 canvas 幅再設定
			window.addEventListener('load', setCanvasSize());
			window.addEventListener('DOMContentLoaded', () => {
				window.addEventListener('resize', () => {

					if (resizeTimer > 0) {
						clearTimeout(resizeTimer);
					}
					resizeTimer = setTimeout(() => {
						setCanvasSize();
					}, 1000);
				});
			});


			// キャンバス
			var src_canvas;
			var src_ctx;

			// イメージ
			var image;

			// 矩形用
			var MIN_WIDTH = 3;
			var MIN_HEIGHT = 3;

			var rect_MousedownFlg = false;
			var rect_sx = 0;
			var rect_sy = 0;
			var rect_ex = 0;
			var rect_ey = 0;

			window.onload = function () {

				src_ctx = canvasElement.getContext("2d");

				rec_ctx = canvasElement2.getContext("2d");
				canvasElement2.width = canvasElement2.height = 1;

				// image = document.getElementById("img_source");
				// image = document.querySelector('#canvas');
			}

			// 色の反転
			function getTurningAround(color) {

				// 灰色は白にする 
				if (color >= 88 && color <= 168) {
					return 255;
					// 色を反転する  
				} else {
					return 255 - color;
				}
			}

			function OnMousedown(event) {

				rect_MousedownFlg = true;

				urlEmement.innerHTML = null;

				// 座標を求める
				var rect = event.target.getBoundingClientRect();
				rect_sx = rect_ex = event.clientX - rect.left;
				rect_sy = rect_ey = event.clientY - rect.top;

				// 矩形の枠色を反転させる  
				var imagedata = src_ctx.getImageData(rect_sx, rect_sy, 1, 1);
				src_ctx.strokeStyle = 'rgb(' + getTurningAround(imagedata.data[0]) +
					',' + getTurningAround(imagedata.data[1]) +
					',' + getTurningAround(imagedata.data[2]) + ')';
				// 線の太さ                         
				src_ctx.lineWidth = 2;

				// 矩形の枠線を点線にする
				src_ctx.setLineDash([2, 3]);
			}

			function OnMousemove(event) {

				if (rect_MousedownFlg) {

					// 座標を求める
					var rect = event.target.getBoundingClientRect();
					rect_ex = event.clientX - rect.left;
					rect_ey = event.clientY - rect.top;

					// 元画像の再描画
					src_ctx.drawImage(image, 0, 0);

					// 矩形の描画
					src_ctx.beginPath();

					// 上
					src_ctx.moveTo(rect_sx, rect_sy);
					src_ctx.lineTo(rect_ex, rect_sy);

					// 下
					src_ctx.moveTo(rect_sx, rect_ey);
					src_ctx.lineTo(rect_ex, rect_ey);

					// 右
					src_ctx.moveTo(rect_ex, rect_sy);
					src_ctx.lineTo(rect_ex, rect_ey);

					// 左
					src_ctx.moveTo(rect_sx, rect_sy);
					src_ctx.lineTo(rect_sx, rect_ey);

					src_ctx.stroke();
				}
			}

			function OnMouseup(event) {

				// キャンバスの範囲外は無効にする    
				if (rect_sx === rect_ex && rect_sy === rect_ey) {
					// 初期化
					src_ctx.drawImage(image, 0, 0);
					rect_sx = rect_ex = 0;
					rect_sy = rect_ey = 0;
					canvasElement2.width = canvasElement2.height = 1;
				}

				// 矩形の画像を取得する
				if (rect_MousedownFlg) {

					// 矩形のサイズ
					canvasElement2.width = Math.abs(rect_sx - rect_ex);
					canvasElement2.height = Math.abs(rect_sy - rect_ey);
					console.log(canvasElement2.width, canvasElement2.height);

					// 指定のサイズ以下は無効にする[3x3]
					if (!(canvasElement2.width >= MIN_WIDTH && canvasElement2.height >= MIN_HEIGHT)) {
						// 初期化
						src_ctx.drawImage(image, 0, 0);
						rect_sx = rect_ex = 0;
						rect_sy = rect_ey = 0;
						canvasElement2.width = canvasElement2.height = 1;
					} else {
						// 矩形用キャンバスへ画像の転送
						rec_ctx.drawImage(image,
							Math.min(rect_sx, rect_ex), Math.min(rect_sy, rect_ey),
							Math.max(rect_sx - rect_ex, rect_ex - rect_sx), Math.max(rect_sy - rect_ey, rect_ey - rect_sy),
							0, 0, canvasElement2.width, canvasElement2.height);
					}
				}

				rect_MousedownFlg = false;
			}

			function onDragOver(event) {
				event.preventDefault();
			}

			function onDrop(event) {
				onAddFile(event);
				event.preventDefault();
			}

			//ユーザーによりファイルが追加された

			function onAddFile(event) {
				var files;
				var reader = new FileReader();

				if (event.target.files) {
					files = event.target.files;
				} else {
					files = event.dataTransfer.files;
				}

				// ファイルが読み込まれた
				reader.onload = function (event) {

					// イメージが読み込まれた
					image.onload = function () {
						src_canvas.width = image.width;
						src_canvas.height = image.height;

						// キャンバスに画像を描画
						src_ctx.drawImage(image, 0, 0);
					};

					// イメージが読み込めない
					image.onerror = function () {
						alert('このファイルは読み込めません。');
					};

					image.src = reader.result;
				};

				if (files[0]) {
					reader.readAsDataURL(files[0]);
					document.getElementById("inputfile").value = '';
				}
			}





			canvasElement.addEventListener('mouseup', () =>
				html2canvas(canvasElement2).then(canvas => {
					checkqrcode(canvas);
				})
			);
		</script>
	</body>
</html>